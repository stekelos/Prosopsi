<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stefanaik - Πρόγραμμα Προπόνησης</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }
        .days-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .days-group {
            flex: 1 1 30%;
        }
        button {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #218838;
        }
        #trainingPlan {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            font-family: 'Arial Unicode MS', Arial, sans-serif;
        }
        .week {
            margin-bottom: 20px;
            page-break-inside: avoid;
            break-inside: avoid;
        }
        .day {
            margin-left: 20px;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        .signature {
            margin-top: 20px;
            text-align: center;
            font-style: italic;
            page-break-inside: avoid;
            break-inside: avoid;
        }
    </style>
</head>
<body>
    <h1>Stefanaik - Δημιουργία Προγράμματος Προπόνησης</h1>
    <form id="trainingForm">
        <div class="form-group">
            <label for="name">Όνομα:</label>
            <input type="text" id="name" name="name" required>
        </div>
        <div class="form-group">
            <label>Ποιες μέρες θα γυμναστείτε; (Επιλέξτε τουλάχιστον 3)</label>
            <div class="days-container">
                <div class="days-group">
                    <input type="checkbox" name="days" value="0"> Δευτέρα<br>
                    <input type="checkbox" name="days" value="1"> Τρίτη<br>
                    <input type="checkbox" name="days" value="2"> Τετάρτη
                </div>
                <div class="days-group">
                    <input type="checkbox" name="days" value="3"> Πέμπτη<br>
                    <input type="checkbox" name="days" value="4"> Παρασκευή<br>
                    <input type="checkbox" name="days" value="5"> Σάββατο
                </div>
                <div class="days-group">
                    <input type="checkbox" name="days" value="6"> Κυριακή
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="distance">Απόσταση αγώνα:</label>
            <select id="distance" name="distance" required>
                <option value="5">5 χλμ</option>
                <option value="10">10 χλμ</option>
                <option value="21.1">Ημιμαραθώνιος (21.1 χλμ)</option>
                <option value="42.2">Μαραθώνιος (42.2 χλμ)</option>
            </select>
        </div>
        <div class="form-group">
            <label for="raceDate">Ημερομηνία αγώνα:</label>
            <input type="date" id="raceDate" name="raceDate" required>
        </div>
        <div class="form-group">
            <label for="weeklyMileage">Χιλιόμετρα ανά εβδομάδα (τρέχοντα):</label>
            <input type="number" id="weeklyMileage" name="weeklyMileage" min="1" step="0.1" required>
        </div>
        <button type="submit">Δημιουργία Προγράμματος</button>
        <button type="button" id="downloadPdf" style="display: none;" onclick="downloadPDF()">Λήψη ως PDF</button>
    </form>
    <div id="errorMessage" class="error"></div>
    <div id="trainingPlan"></div>

    <script>
        document.getElementById('trainingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generateTrainingPlan();
        });

        function generateTrainingPlan() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = '';
            document.getElementById('trainingPlan').innerHTML = '';

            const name = document.getElementById('name').value;
            const days = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(d => parseInt(d.value));
            const raceDistance = parseFloat(document.getElementById('distance').value);
            const raceDateInput = document.getElementById('raceDate').value;
            let weeklyMileage = parseFloat(document.getElementById('weeklyMileage').value);
            const today = new Date('2025-05-10');

            // Validation
            if (!name) {
                errorDiv.textContent = 'Παρακαλώ εισάγετε το όνομά σας.';
                return;
            }
            if (days.length < 3) {
                errorDiv.textContent = 'Παρακαλώ επιλέξτε τουλάχιστον 3 μέρες προπόνησης.';
                return;
            }
            if (isNaN(raceDistance)) {
                errorDiv.textContent = 'Παρακαλώ επιλέξτε απόσταση αγώνα.';
                return;
            }
            if (!raceDateInput) {
                errorDiv.textContent = 'Παρακαλώ επιλέξτε ημερομηνία αγώνα.';
                return;
            }
            if (isNaN(weeklyMileage) || weeklyMileage <= 0) {
                errorDiv.textContent = 'Παρακαλώ εισάγετε έγκυρα εβδομαδιαία χιλιόμετρα.';
                return;
            }

            const raceDate = new Date(raceDateInput);
            const distanceText = document.getElementById('distance').options[document.getElementById('distance').selectedIndex].text;

            // Find next Monday
            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + ((1 + 7 - today.getDay()) % 7 || 7));

            // Calculate weeks until race
            const msPerWeek = 7 * 24 * 60 * 60 * 1000;
            const weeks = Math.ceil((raceDate - nextMonday) / msPerWeek);
            if (weeks < 2) {
                errorDiv.textContent = 'Ο αγώνας πρέπει να είναι τουλάχιστον 2 εβδομάδες μετά τις 19 Μαΐου 2025.';
                return;
            }

            // Initialize training plan
            let plan = `<h2>Προσωποποιημένο Πρόγραμμα για ${name} στα ${distanceText}</h2>`;
            let currentMileage = weeklyMileage * 0.9; // First week -10%
            const qualityWeeksStart = weeks - 6; // Last 5 weeks before race week for quality
            const dayNames = ['Δευτέρα', 'Τρίτη', 'Τετάρτη', 'Πέμπτη', 'Παρασκευή', 'Σάββατο', 'Κυριακή'];
            let prevWeekThresholdDistance = 0;

            try {
                for (let week = 1; week <= weeks; week++) {
                    const weekStart = new Date(nextMonday.getTime() + (week - 1) * msPerWeek);
                    let weekMileage = week === weeks ? 0 : week === weeks - 1 ? currentMileage * 0.8 : currentMileage;
                    let longRun = week === weeks ? 0 : weekMileage * 0.25;
                    let easyRun = days.length > 1 && week !== weeks ? (weekMileage - longRun) / (days.length - 1) : 0;

                    // Quality workouts
                    let qualityDays = [];
                    if (week >= 2 && week <= qualityWeeksStart || week > qualityWeeksStart && week < weeks) {
                        qualityDays = selectQualityDays(days, 2);
                    } else if (week === weeks) {
                        qualityDays = [days[0]]; // Threshold on the first training day
                    }

                    // Last week special case
                    if (week === weeks) {
                        weekMileage = 5 + 5 + (prevWeekThresholdDistance * 0.8 + 4); // 2 easy runs (5km), reduced threshold + 4km (warm-up/cool-down Laat
                    }

                    plan += `<div class="week"><h2>Εβδομάδα ${week} (από ${weekStart.toLocaleDateString('el-GR')}) - ${weekMileage.toFixed(1)} χλμ</h2>`;

                    let easyRunCount = week === weeks ? 2 : 0;
                    let thresholdAssigned = false;

                    for (let i = 0; i < 7; i++) {
                        const currentDate = new Date(weekStart);
                        currentDate.setDate(weekStart.getDate() + i);
                        if (week === weeks && currentDate.toDateString() === raceDate.toDateString()) {
                            plan += `<div class="day"><strong>${dayNames[i]} (${currentDate.toLocaleDateString('el-GR')}):</strong> Αγώνας - ${raceDistance} χλμ</div>`;
                            continue;
                        }
                        if (!days.includes(i)) {
                            plan += `<div class="day"><strong>${dayNames[i]} (${currentDate.toLocaleDateString('el-GR')}):</strong> Ξεκούραση</div>`;
                            continue;
                        }

                        if (week === weeks && qualityDays.includes(i) && !thresholdAssigned) {
                            const distance = prevWeekThresholdDistance * 0.8; // 20% less than previous week
                            const splits = getSplits('Threshold', distance);
                            plan += `<div class="day"><strong>${dayNames[i]} (${currentDate.toLocaleDateString('el-GR')}):</strong> Threshold - 2 χλμ ζέσταμα, ${splits}, 2 χλμ αποθεραπεία (Σύνολο: ${(distance + 4).toFixed(1)} χλμ)</div>`;
                            thresholdAssigned = true;
                            continue;
                        }

                        if (week === weeks && easyRunCount > 0) {
                            plan += `<div class="day"><strong>${dayNames[i]} (${currentDate.toLocaleDateString('el-GR')}):</strong> Easy Run - 5 χλμ</div>`;
                            easyRunCount--;
                            continue;
                        }

                        if (i === days[days.length - 1] && week !== weeks) {
                            plan += `<div class="day"><strong>${dayNames[i]} (${currentDate.toLocaleDateString('el-GR')}):</strong> Long Run - ${longRun.toFixed(1)} χλμ</div>`;
                        } else if (qualityDays.includes(i) && week !== weeks) {
                            const type = qualityDays.indexOf(i) === 0 ? 'Threshold' : week > qualityWeeksStart ? 'Interval' : 'Repetition';
                            const distance = type === 'Threshold' ? weekMileage * 0.12 : type === 'Interval' ? weekMileage * 0.07 : weekMileage * 0.05;
                            if (type === 'Threshold') prevWeekThresholdDistance = distance;
                            const splits = getSplits(type, distance);
                            plan += `<div class="week"><strong>${dayNames[i]} (${currentDate.toLocaleDateString('el-GR')}):</strong> ${type} - 2 χλμ ζέσταμα, ${splits}, 2 χλμ αποθεραπεία (Σύνολο: ${(distance + 4).toFixed(1)} χλμ)</div>`;
                        } else if (week !== weeks) {
                            plan += `<div class="day"><strong>${dayNames[i]} (${currentDate.toLocaleDateString('el-GR')}):</strong> Easy Run - ${easyRun.toFixed(1)} χλμ</div>`;
                        }
                    }
                    plan += '</div>';
                    currentMileage *= 1.05; // Increase mileage by 5%
                }

                // Add signature
                plan += `<div class="signature">Created with love by Stefanos</div>`;

                document.getElementById('trainingPlan').innerHTML = plan;
                document.getElementById('downloadPdf').style.display = 'inline-block';
            } catch (error) {
                errorDiv.textContent = 'Σφάλμα κατά τη δημιουργία του προγράμματος: ' + error.message;
                console.error(error);
            }
        }

        function selectQualityDays(days, count) {
            let selected = [];
            for (let i = 0; i < days.length && selected.length < count; i++) {
                if (!selected.length || Math.abs(days[i] - selected[selected.length - 1]) > 1) {
                    selected.push(days[i]);
                }
            }
            return selected;
        }

        function getSplits(type, distance) {
            const thresholds = [1000, 1200, 1600, 2000];
            const intervals = [200, 300, 400, 500];
            const repetitions = [200, 300, 400];
            const options = type === 'Threshold' ? thresholds : type === 'Interval' ? intervals : repetitions;
            let remaining = distance * 1000;
            let splits = [];
            while (remaining > 0) {
                const split = options[Math.min(Math.floor(remaining / 1000), options.length - 1)];
                const count = Math.floor(remaining / split);
                if (count > 0) {
                    splits.push(`${count}x${split}μ`);
                    remaining -= count * split;
                } else {
                    break;
                }
            }
            return splits.join(', ');
        }

        function downloadPDF() {
            const element = document.getElementById('trainingPlan');
            const opt = {
                margin: [0.3, 0.3, 0.3, 0.3], // Reduced margins to fit more content
                filename: 'Stefanaik_Training_Plan.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, windowWidth: 800 }, // Fixed width for consistent rendering
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
                pagebreak: { mode: ['css', 'legacy'], avoid: ['.week', '.signature'] } // Explicitly avoid breaking weeks and signature
            };
            html2pdf().from(element).set(opt).toPdf().get('pdf').then(function (pdf) {
                pdf.setFont("Arial", "normal");
            }).save();
        }
    </script>
</body>
</html>
